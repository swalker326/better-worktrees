# Better WorkTree Big-Bang Rewrite Plan

## Product direction (locked)
- Do a full rewrite of the TUI architecture and interaction model.
- Use modern OpenTUI primitives directly in the UX: `select`, `tab-select`, `scrollbox`, visible scrollbar patterns.
- Match gwt-like behavior for command semantics (`list/create/delete`) and repo resolution.
- Core user model: choose any repo/worktree path -> resolve canonical repo root -> show all git worktrees for that repo.
- Keep global config at `~/.config/bwt/config.json`, naming template `BWT_<project_name>_wt_<branch_name>`, and copy-after-create behavior.

## Root problems to fix first
- `resolveRepo()` precedence is wrong (`lastRepo` beats cwd), causing list/create/delete to act on the wrong repo.
- TUI add-repo flow can save highlighted suggestion instead of typed value.
- TUI selected repo index and active repo can drift.
- Current-worktree marker is inferred too loosely.
- Config `repoOrder` can duplicate entries.
- `repo set-copy` can implicitly create repo entries.

## Rewrite architecture

### 1) Core domains
- `RepoDomain`: tracked repos, opened-but-not-saved repo roots, active repo path, repo filter.
- `WorktreeDomain`: canonical worktree list for active repo, selection by path, filter, loading/error.
- `UiDomain`: active tab, focus target, status line, busy state.
- `DialogDomain`: stack-based overlays (`openRepo`, `create`, `confirmDelete`, `repoSettings`).

### 2) Controller + key routing
- Replace monolithic key handling with controller + reducer pattern.
- Central key router precedence:
  1. active dialog
  2. focused control
  3. global shortcuts
- Use `renderer.destroy()` for exits (no direct `process.exit()` inside TUI interactions).

### 3) Visual system
- Move to semantic theme tokens (background, panel, muted, accent, focus border, warning, success).
- Strong hierarchy: top command bar + tab strip + split panels + overlay dialogs + compact status/footer.
- Use nested text modifiers (`<span>`, `<strong>`) for styling emphasis in React OpenTUI.

## File-level implementation plan

### Core behavior fixes
- `src/core/services/worktreeService.ts`
  - Rewrite repo resolution precedence to: explicit `--repo` -> cwd repo root -> `lastRepo` -> error.
  - Add helper to resolve arbitrary input path (repo or worktree) to canonical repo root.
- `src/core/git/worktrees.ts`
  - Tighten `isCurrent` logic to path/context-based behavior instead of branch-name assumptions.
- `src/core/config/schema.ts`
  - Dedupe `repoOrder` on normalize, preserve order.
- `src/core/services/repoService.ts`
  - Add strict update helpers so setting updates require existing tracked repo.
- `src/cli/commands/repo.ts`
  - Ensure `set-copy` fails for unknown repos (never implicit add).

### TUI big-bang rewrite
- Replace current TUI composition and state machine in `src/tui/App.tsx`.
- Add new state/control modules:
  - `src/tui/state/appReducer.ts`
  - `src/tui/state/selectors.ts`
  - `src/tui/hooks/useAppController.ts`
  - `src/tui/hooks/useKeyRouter.ts`
- Add modern shell/components:
  - `src/tui/components/AppShell.tsx`
  - `src/tui/components/TopTabs.tsx` (`tab-select`)
  - `src/tui/components/RepoSelectPanel.tsx` (`select`)
  - `src/tui/components/WorktreeScrollPanel.tsx` (`scrollbox` + scrollbar)
  - `src/tui/components/DialogLayer.tsx`
  - `src/tui/components/StatusFooter.tsx`
- Refactor existing modal components into pure content blocks:
  - `src/tui/components/CreateWorktreeModal.tsx`
  - `src/tui/components/DeleteConfirmModal.tsx`
  - `src/tui/components/RepoSettingsModal.tsx`
- Deprecate/replace old screen components as needed:
  - `src/tui/screens/RepoPicker.tsx`
  - `src/tui/screens/WorktreeList.tsx`

### CLI parity hardening
- `src/cli/commands/list.ts`, `src/cli/commands/create.ts`, `src/cli/commands/delete.ts`
  - consume fixed resolver behavior and ensure outputs reflect canonical repo root context.
- `src/cli/output.ts`
  - update current-marker display to match corrected core semantics.

### Docs updates
- `README.md`
  - refresh keymap, tab model, repo/worktree discovery semantics, and modern TUI behavior.

## Modern TUI blueprint

### Top bar
- Brand + active repo root + quick metrics (repo count, worktree count, filtered count).

### Tab strip (`tab-select`)
- Tabs: `Worktrees`, `Repositories`, `Settings`.
- Keyboard: `left/right` to move, `enter` to activate.

### Worktrees tab
- Left: repo selector (`select`) showing tracked + opened roots.
- Right: worktree stream (`scrollbox`) with row cards and scrollbar for long lists.
- Row content: current marker, branch, role (`main|wt`), path, lock/prune indicators.

### Repositories tab
- `select` for tracked repos with actions: open path, save/remove, activate.
- Open-any-path dialog with autocomplete suggestions; typed value remains default unless suggestion explicitly chosen.

### Settings tab
- Repo-scoped naming template and copy rules editor.
- Rules list in scrollable region for larger configs.

### Dialog layer
- Stack-based overlays with focus capture + restore.
- Dialogs: create, delete confirm, open repo, edit template/rules, help.

## Keyboard model
- Global: `q` quit, `?` help, `tab` cycle focus zones, `/` filter current pane, `r` refresh.
- List navigation: `j/k` + arrows, page moves, home/end.
- Worktree actions: `a` create, `d` delete.
- Repo actions: `o` open path, `s` save tracked repo, `x` remove tracked repo.
- Dialog keys: `enter` confirm, `esc` cancel.

## Execution sequence (minimal-risk big bang)
1. Fix core resolver/config/CLI correctness bugs and add tests.
2. Introduce new TUI state/controller/key-router scaffolding (no visual switch yet).
3. Implement new AppShell with tabs + semantic theme.
4. Land `select`-based repo panel and stable selection-by-path model.
5. Land `scrollbox` worktree panel with scrollbar and richer row rendering.
6. Integrate dialog stack and refactor create/delete/settings flows.
7. Remove old TUI paths and finalize docs/keymap.

## Verification

### Automated tests
- Add/update tests for:
  - resolver precedence (`cwd` over `lastRepo`) in `src/core/services/worktreeService.test.ts`
  - worktree parser/current marker in `src/core/git/worktrees.test.ts`
  - config dedupe in `src/core/config/schema.test.ts`
  - `repo set-copy` strictness in CLI tests
- Run full `bun test` and `bunx tsc --noEmit`.

### Manual E2E checks
- In a cwd that is a repo/worktree, `bwt list` targets that repo even if another `lastRepo` exists.
- In TUI, open/select any repo path and see complete worktree set from git.
- Add/open path flow does not auto-replace typed path with suggestion unless explicitly selected.
- Create/delete flows work from the new dialog stack and refresh list correctly.
- Settings updates affect naming template + copy rules and persist to config.

## Acceptance criteria
- TUI feels modern: tabbed navigation, focused list controls, scrollable worktree panel, crisp visual hierarchy.
- Repo/worktree discovery matches git reality, not stale UI state.
- gwt-like command trust is restored for list/create/delete defaults.
